<!DOCTYPE html>
<html lang="en">
{% load static %}
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <title>Booking Form HTML Template</title>

    <!-- Google font -->
    <link href="https://fonts.googleapis.com/css?family=Montserrat:400,700" rel="stylesheet">
<link href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css" rel="stylesheet">
    <!-- Bootstrap -->
    <link type="text/css" rel="stylesheet" href="{% static 'bookingcss/bootstrap.min.css' %}" />

    <!-- Custom stylesheet -->
    <link type="text/css" rel="stylesheet" href="{% static 'bookingcss/style.css' %}" />

    <!-- jQuery UI CSS -->
    <link rel="stylesheet" href="https://code.jquery.com/ui/1.12.1/themes/base/jquery-ui.css">

    <!-- Bootstrap Datepicker CSS -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-datepicker/1.9.0/css/bootstrap-datepicker.min.css" rel="stylesheet">

    <!-- HTML5 shim and Respond.js for IE8 support of HTML5 elements and media queries -->
    <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
    <!--[if lt IE 9]>
          <script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
          <script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
    <![endif]-->
    <style>
        .nav1 {
            background: white;
            width: 100%;
            height: 75px;
            overflow: hidden;
            z-index: 1000;
            position: fixed;
            top: 0;
            left: 0px;
        }
        .error1 {
            color: green;
            font-size: 15px;
        }
        .datepicker-days .day.disabled1 {
            background-color: rgb(174, 137, 137) !important;
            color: white !important;
            cursor: not-allowed;
        }
        .k {
        border-radius: 100%;
    }
    .n9 {
        color: black;
        text-decoration: none;
        margin-top: -10px;
        margin-bottom: 10px;

        padding: 10 21;
        text-transform: uppercase;
        float: left;

    }

    .n9:hover {

        text-decoration: none;
        font-weight: bold;
        color: green;
    }

    .dropdown:hover .dropdown-content {
        display: block;
    }

   


    .desc {
        padding: 15px;
        text-align: center;

    }

    .dropdown {
        position: relative;
        display: inline-block;
        margin-top: 5px;
        margin-left: 40px;
    }

    .dropdown-content {
        display: none;
        position: absolute;
        background-color: #564646;
        min-width: 190px;
        box-shadow: 0px 8px 16px 0px rgba(0, 0, 0, 0.2);
        z-index: 1;
        margin-left: -140px;
        
    }
    .dropdown:hover .dropdown-content {
        display: block;
    }
    .service-item {
            background-color: #f8f9fa;
            border-radius: 10px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
            overflow: hidden;
            margin-bottom: 20px;
            transition: transform 0.3s, box-shadow 0.3s;
        }
        .service-item:hover {
            transform: translateY(-10px);
            box-shadow: 0 8px 16px rgba(0, 0, 0, 0.2);
        }
        .service-item img {
            width: 100%;
            height: auto;
            border-bottom: 1px solid #ddd;
        }
        .down-content {
            padding: 20px;
        }
        .down-content h4 {
            font-size: 1.5em;
            margin-bottom: 10px;
        }
        .down-content h5 {
            font-size: 1em;
            color: #777;
            margin-bottom: 15px;
        }
        .down-content .price {
            font-size: 1.2em;
            color: #dc3545;
        }
        .filled-button {
            background-color: #007bff;
            color: #fff;
            padding: 10px 20px;
            border-radius: 5px;
            text-transform: uppercase;
            text-decoration: none;
            transition: background-color 0.3s;
        }
        .filled-button:hover {
            background-color: #0056b3;
        }
  

.container {
    max-width: 1200px;
    margin: auto;
    padding: 20px;
}


.col-md-4 {
    flex: 1 1 calc(33.333% - 20px); /* Three columns with space for gaps */
    box-sizing: border-box;
}

.service-item {
    background-color: #fff;
    border-radius: 10px;
    box-shadow: 0 8px 16px rgba(0, 0, 0, 0.2);
    overflow: hidden;
    transition: transform 0.3s ease, box-shadow 0.3s ease;
    border: 1px solid #ddd;
    text-align: left; /* Align text to the left */
}

.service-item:hover {
    transform: translateY(-5px);
    box-shadow: 0 12px 24px rgba(0, 0, 0, 0.3);
}

.service-item img {
    width: 100%;
    height: auto;
    object-fit: cover;
    display: block;
}

.down-content {
    padding: 15px;
}

.down-content h4 {
    font-size: 1.5em;
    margin-bottom: 10px;
    color: #007bff;
}

.down-content h5 {
    font-size: 1.1em;
    color: #555;
    margin-bottom: 10px;
}

.price {
    font-size: 1.2em;
    color: #28a745;
    margin-bottom: 15px;
}

.filled-button {
    background-color: #007bff;
    color: #fff;
    padding: 10px 20px;
    border-radius: 5px;
    text-transform: uppercase;
    text-decoration: none;
    display: inline-block;
    transition: background-color 0.3s ease;
}

.filled-button:hover {
    background-color: #0056b3;
}

.navbar-custom {
    background-color: #4CAF50; /* Change to your desired navbar color */
    position: fixed;
    width: 100%;
    top: 0;
    left: 0;
    z-index: 1000;
}

.navbar-custom .navbar-brand img {
    max-height: 52px;
}

.navbar-custom .navbar-nav .nav-link {
    color: white;
    font-weight: 600;
    font-size: 16px;
    padding: 15px 20px;
    transition: color 0.3s, background-color 0.3s;
}

.navbar-custom .navbar-nav .nav-link:hover,
.navbar-custom .navbar-nav .nav-link.active {
    color: #fff;
    background-color: #45a049; /* Darker green for hover */
    border-radius: 5px;
}

/* Dropdown Styles */

.dropdown img {
    border-radius: 50%;
}



.dropdown-content a {
    color: white;
    padding: 12px 16px;
    text-decoration: none;
    display: block;
    text-align: center;
    transition: background-color 0.3s;
}

.dropdown-content a:hover {
    background-color: #575757;
}

.dropdown:hover .dropdown-content {
    display: block;
}

/* Responsive Adjustments */
@media (max-width: 768px) {
    .navbar-nav {
        text-align: center;
    }
    .navbar-nav .nav-link {
        padding: 10px 15px;
    }
    
}
.time-slot-select {
    position: relative;
    appearance: none;
    -webkit-appearance: none;
    -moz-appearance: none;
    background: url('data:image/svg+xml;utf8,<svg fill="%23333" height="24" viewBox="0 0 24 24" width="24" xmlns="http://www.w3.org/2000/svg"><path d="M7 10l5 5 5-5z"/></svg>') no-repeat right 10px center;
    background-color: white;
    border: 1px solid #ddd;
    border-radius: 4px;
    padding: 8px 16px;
    padding-right: 40px; /* space for the arrow */
    font-size: 16px;
}

    .disabled-slot {
        background-color: #640c0c; /* Light gray background for disabled slots */
        color: #a0a0a0; /* Light gray text color for disabled slots */
      /* Change cursor to indicate slot is disabled */
    }
    .disabled1 {
    background-color: #f8d7da; /* Light red background for booked slots */
    color: #721c24; /* Dark red text color */
}
.booked-slot {
    background-color: #f8d7da; /* Light red background for booked slots */
    color: #721c24; /* Dark red text color */
}

.available-slot {
    background-color: #d4edda; /* Light green background for available slots */
    color: #155724; /* Dark green text color */
}
    </style>
    <!-- SweetAlert CSS -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.min.css">
    <style>
        .swal2-popup {
            font-size: 1.6rem; /* Increase font size */
            width: 600px; /* Increase width */
            height: auto; /* Adjust height */
        }
        .swal2-title {
            font-size: 2rem; /* Increase title size */
        }
        .swal2-content {
            font-size: 1.4rem; /* Increase content size */
        }
        .swal2-confirm {
            font-size: 1.2rem; /* Increase button size */
        }
    </style>
</head>
<script>
      function showAlert() {
    alert("You have been successfully booked the service.");
    

  }

</script>
<body>
    <!-- jQuery -->
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <!-- Bootstrap JS -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.1.3/js/bootstrap.bundle.min.js"></script>

    <!-- Bootstrap Datepicker JS -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-datepicker/1.9.0/js/bootstrap-datepicker.min.js"></script>

    <!-- Navbar -->
    
     

            <nav class="navbar navbar-expand-lg navbar-custom">
                <div style="margin-top: -30px;">
                <a class="navbar-brand" href="{% url 'userloginhome' %}">
                    <img src="{% static 'images/logonew.png' %}" alt="Company Logo">
                </a>
            </div>
                <div style="margin-left: 350px;">
                <div class="collapse navbar-collapse" id="navbarNav">
                    <ul class="navbar-nav ml-auto">
                        <li class="nav-item">
                            <a class="nav-link" href="{% url 'userloginhome' %}">Home</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="{% url 'userloginhome' %}#about">About Us</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="{% url 'userloginhome' %}#projects">Images</a>
                        </li>
                        <li class="nav-item active">
                            <a class="nav-link" href="{% url 'servicelogin' %}">Services</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="{% url 'userloginhome' %}#contact-us">Contact Us</a>
                        </li>
                        <li class="nav-item">
                            <div class="dropdown">
                                <img src="{% static user.photo.url %}" alt="User Photo" width="70" height="50" class="k">
                                <div class="dropdown-content">
                                    <a href="{% url 'useraccount' %}" target="__blank">Manage Account</a>
                                    <a href="bookingview.php">My Bookings</a>
                                    <a href="{% url 'logout' %}">Logout</a>
                                </div>
                            </div>
                        </li>
                    </ul>
                </div>
            </div>
            </nav>
        </div>
    </nav1>

    <!-- Booking Form -->
    <form id="bookingForm" action="{% url 'book' %}" method="POST" onsubmit="showAlertAndSubmit(event)">
        {% csrf_token %}
        <div id="booking" class="section">
            <div class="section-center"><br>
                <div class="container">
                    <div class="row">
                        <div class="col-md-7 col-md-push-5">
                            <div class="booking-cta">
                                <h1>BOOK YOUR SERVICE</h1>
                                <p>
                                    <font color="white">
                                        <h4>At Expert Homecare, we understand the importance of a well-maintained home and the peace of mind that comes with it. Whether you need a skilled plumber to fix a leaky faucet, an experienced electrician to handle your wiring issues, or any other home maintenance service, we are here to help. Our team of certified professionals is dedicated to providing top-notch services with utmost reliability and efficiency.</h4>
                                    </font>
                                </p>
                            </div>
                        </div>
                        <div class="col-md-4 col-md-pull-7">
                            <div class="booking-form">
                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="form-group">
                                            <span class="form-label">Customer Name</span>
                                            <input class="form-control" type="text" placeholder="Service Provider Name" value="{{ user.first_name }} {{ user.last_name }}" name="sp_name" required readonly>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        {% for service_provider_name in service_provider_name %}
                                        <div class="form-group">
                                            <span class="form-label">Service Provider Name</span>
                                            <input class="form-control" type="text" placeholder="Service Provider Name" value="{{service_provider_name.service_provider_name}}" name="sp_name" required readonly>
                                            <input class="form-control" type="hidden" placeholder="Service Provider Name" value="{{service_provider_name.service_provider_id}}" name="serviceid">
                                        </div>
                                    </div>
                                </div>
                                {% endfor %}
                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="form-group">
                                            <span class="form-label">Service Location Address</span>
                                            <input class="form-control" type="text" placeholder="Service Location Address" id="address" name="address" value="{{ user.address }}"required>
                                            <input class="form-control" type="hidden" placeholder="Customer id" value="{{ user.id }}" name="customer_id">
                                            <input class="form-control" type="hidden" placeholder="Service Provider id" value="{{ data_to_display.service_provider_id }}" name="service_provider_id">
                                        </div>
                                    </div>
                                   

                            
                                    <div class="col-md-6">
                                        <div class="form-group">
                                            <span class="form-label">Preferred Dates</span>
                                            <input class="form-control datepicker" type="text" placeholder="Select dates" id="booking_dates" name="dates" required readonly>
                                        </div>
                                    </div>
                                </div>
                                <div class="row">
                                    <div class="col-md-12">
                                        <div class="form-group">
                                            <span id="selected_dates_list1" class="form-label"></span>
                                            <ul id="selected_dates_list" name="timeslot" class="list-group"></ul>
                                            
                                        </div>
                                    </div>
                                </div>
                                <div class="form-group">
                                    <span class="form-label">Description of the Issue or Service Needed</span>
                                    <textarea class="form-control" id="detail" name="detail" placeholder="Description of the Issue or Service Needed..." style="width: 100%; height: 100px;" required></textarea>
                                </div>
                                <br>
                                <div style="margin-top:-20px;"><span id="availability"></span></div><br>
                                <div class="row">
                                    <div class="col-sm-6"></div>
                                </div>
                                <div class="form-btn">
                                    <input type="submit" value="Book" id="register" class="submit-btn">
                                    <div style="margin-left:230px;margin-top:-40px">
                                        <a href="\mathew\miniproject-s6/caravan1.php" class="submit-btn"   style="text-decoration:none">Cancel</a>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-6">
    </form>

  
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-datepicker/1.9.0/js/bootstrap-datepicker.min.js"></script>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-datepicker/1.9.0/css/bootstrap-datepicker.min.css">
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script>
$(document).ready(function() {
    var bookedSlots = JSON.parse('{{ booked_slots|escapejs }}'); // Parse booked slots JSON
    console.log(bookedSlots); // Verify data format

    var mod1 = 1; // Initialize mod1
    var selectedDates = {}; // Object to store selected dates and their time slots

    // Function to update button state
    function updateButtonState() {
        if (mod1 === 1) {
            $('#register').attr("disabled", true).css("background", "lightblue");
        } else {
            $('#register').attr("disabled", false).css("background", "#4272d7");
        }
    }

    // Function to add selected dates to the list with time slot options
    function addSelectedDates(dates) {
        var selectedDatesList = $('#selected_dates_list');
        var list1 = $('#selected_dates_list1');
        list1.empty();
        list1.text("Selected Dates and Slots");
        selectedDatesList.empty(); // Clear the list before adding new dates

        dates.forEach(function(date, index) {
            var dateStr = formatDate(date); // Format date as dd-mm-yyyy
            var listItem = $('<li>').addClass('list-group-item');
            listItem.append(`<span>${dateStr}</span>`);
            var timeSlotSelect = $('<select>')
                .attr('id', 'time-slot-select-' + index) // Assign a unique id
                .addClass('form-control time-slot-select')
                .css('display', 'inline-block')
                .css('width', '150px')
                .css('margin-left', '150px');
               
            timeSlotSelect.append('<option value="am">AM</option>');
            timeSlotSelect.append('<option value="pm">PM</option>');
            timeSlotSelect.append('<option value="fullday">Full Day</option>');
            listItem.append(timeSlotSelect);
            selectedDatesList.append(listItem);

            // Initialize the time slot for the date if not already present
            if (!selectedDates[dateStr]) {
                selectedDates[dateStr] = 'am'; // Default value for time slot
                timeSlotSelect.val('am'); // Set default selection
            } else {
                timeSlotSelect.val(selectedDates[dateStr]); // Set previously selected value
            }
        });

        // Update hidden input with initial time slots
        updateHiddenInputs();
    }

    // Function to format date as dd-mm-yyyy
    function formatDate(date) {
        var day = date.getDate().toString().padStart(2, '0');
        var month = (date.getMonth() + 1).toString().padStart(2, '0');
        var year = date.getFullYear();
        return `${day}-${month}-${year}`;
    }

    // Function to update hidden inputs with selected time slots
    function updateHiddenInputs() {
        // Clear existing hidden input to avoid duplication
        $("input[name='timeslot']").remove();

        var allDateTimeSlots = [];
        $('#selected_dates_list li').each(function() {
            var dateStr = $(this).find('span').text();
            var selectedTimeSlot = $(this).find('.time-slot-select').val();
            selectedDates[dateStr] = selectedTimeSlot; // Update time slot in the dictionary
            allDateTimeSlots.push(selectedTimeSlot); // Collect all time slots
        });

        // Create a single hidden input with all time slots
        $('<input>').attr({
            type: 'hidden',
            name: 'timeslot',
            value: allDateTimeSlots.join(',') // Concatenate all time slots with comma separator
        }).appendTo('form');
    }

    // Event handler for time slot selection change
    $(document).on('change', '.time-slot-select', function() {
        updateHiddenInputs(); // Update hidden input whenever a time slot is changed
    });

    $("#booking_dates").blur(function () {
        var n = $(this).val();
        if (n === "") { // Check for empty string
            mod1 = 1;
        } else {
            mod1 = 0; // Update mod1 to 0 if input is not empty
        }
        updateButtonState(); // Update button state based on mod1
    });

    // Initialize datepicker
    $('.datepicker').datepicker({
        format: 'dd-mm-yyyy',
        startDate: '0d', // Today is the earliest selectable date
        multidate: true,  // Allow multiple date selections
        todayHighlight: true,
        beforeShowDay: function(date) {
            var dateStr = formatDate(date); // Format as dd-mm-yyyy

            // Check if AM and PM slots are booked for the same date
            var isAMPMBooked = bookedSlots.hasOwnProperty(dateStr) &&
                bookedSlots[dateStr].includes('am') &&
                bookedSlots[dateStr].includes('pm');

            // Find the earliest date to disable after a full day booking or AM/PM booked together
            var disableDate = false;
            Object.keys(bookedSlots).forEach(function(bookedDateStr) {
                if (bookedSlots[bookedDateStr].includes('fullday')) {
                    var bookedDate = new Date(bookedDateStr);
                    var dateToDisable = new Date(bookedDate);
                    dateToDisable.setDate(dateToDisable.getDate()); // One day after the full day booking

                    if (formatDate(dateToDisable) === dateStr) {
                        disableDate = true;
                    }
                }
                if (bookedSlots[bookedDateStr].includes('am') && bookedSlots[bookedDateStr].includes('pm')) {
                    var bookedDateAMPM = new Date(bookedDateStr);
                    var dateToDisableAMPM = new Date(bookedDateAMPM);
                    dateToDisableAMPM.setDate(dateToDisableAMPM.getDate() ); // One day after AM/PM booked together

                    if (formatDate(dateToDisableAMPM) === dateStr) {
                        disableDate = true;
                    }
                }
            });

            // Disable the date if it's either one day after a full day booking, has both AM and PM booked, or the date is a booked date
            if (disableDate) {
                return { enabled: false, classes: 'disabled1' };
            }

            // Enable the date
            return { enabled: true };
        }
    }).on('changeDate', function(e) {
        // Enable the button when a date is selected
        if (e.dates.length > 0) {
            mod1 = 0; // Update mod1 to 0 when dates are selected
            addSelectedDates(e.dates); // Add selected dates with time slot options
        } else {
            mod1 = 1; // Update mod1 to 1 when no dates are selected
            $('#selected_dates_list').empty(); // Clear the list when no dates are selected
            selectedDates = {}; // Clear selected dates dictionary
        }
        updateButtonState(); // Update button state based on mod1
    });

    // Disable time slots based on selected date and booked slots
    $(document).on('click', '.time-slot-select', function() {
        var selectedDate = $(this).closest('li').find('span').text();
        var dateStr = new Date(selectedDate.split('-').reverse().join('-')).toISOString().slice(0, 10);
        console.log(dateStr);

        // Disable time slots based on booked slots
        var timeSlots = bookedSlots[dateStr] || [];
        console.log(timeSlots);

        var $select = $(this);

        // Disable the entire select element if the full day option should be disabled
        if (timeSlots.includes('am') || timeSlots.includes('pm')) {
            console.log("lksjf")
            $select.find('option[value="fullday"]').prop('disabled', true).addClass('disabled-slot');
        } else {
            $select.find('option[value="fullday"]').prop('disabled', false).removeClass('disabled-slot');
        }

        $select.find('option').each(function() {
            var slotValue = $(this).val();
            
            if (timeSlots.includes(slotValue)) {
                $(this).prop('disabled', true).addClass('disabled-slot'); // Disable and style the slot
            } else {
                //$(this).prop('disabled', false).removeClass('disabled-slot'); // Enable and remove style from the slot
            }
        });
    });

    // Initially set the button state based on mod1
    updateButtonState();
});

    function showAlertAndSubmit(event) {
        event.preventDefault(); // Prevent the default form submission

        Swal.fire({
            title: 'Success!',
            text: 'You have successfully booked the service.',
            icon: 'success',
            confirmButtonText: 'OK',
            timer: 4000, // Display for 4 seconds
            timerProgressBar: true, // Show a progress bar
            customClass: {
                popup: 'swal2-popup',
                title: 'swal2-title',
                content: 'swal2-content',
                confirmButton: 'swal2-confirm'
            }
        }).then((result) => {
            if (result.isConfirmed || result.dismiss === Swal.DismissReason.timer) {
                // Submit the form after the alert is closed
                document.getElementById('bookingForm').submit();
            }
        });
    }
</script>
</body>
</html>
